{% extends 'base.html.twig' %}
{% block title %}Raporty{% endblock %}
{% block body %}
    <h2>Raporty</h2>
    <form class="row g-2 mb-3" method="get">
        <div class="col-auto">
            <label for="filter_from" class="visually-hidden">Od</label>
            <input id="filter_from" class="form-control" type="date" name="from" value="{{ app.request.get('from') }}">
        </div>
        <div class="col-auto">
            <label for="filter_to" class="visually-hidden">Do</label>
            <input id="filter_to" class="form-control" type="date" name="to" value="{{ app.request.get('to') }}">
        </div>
        <div class="col-auto">
            <label for="filter_household" class="visually-hidden">Gospodarstwo</label>
            <input id="filter_household" class="form-control" type="text" name="household" placeholder="UUID gospodarstwa"
                                     value="{{ app.request.get('household') }}">
        </div>
        <div class="col-auto">
            <label for="filter_store" class="visually-hidden">Sklep</label>
            <select id="filter_store" name="store" class="form-select">
                <option value="">Wszystkie sklepy</option>
                {% for s in stores %}
                    <option value="{{ s.id }}" {% if app.request.get('store') == s.id %}selected{% endif %}>{{ s.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-auto">
            <label for="filter_category" class="visually-hidden">Kategoria</label>
            <select id="filter_category" name="category" class="form-select">
                <option value="">Wszystkie kategorie</option>
                {% for c in categories %}
                    <option value="{{ c.id }}" {% if app.request.get('category') == c.id %}selected{% endif %}>{{ c.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-auto">
            <label for="filter_product" class="visually-hidden">Produkt</label>
            <select id="filter_product" name="product" class="form-select">
                <option value="">Wszystkie produkty</option>
                {% for p in products %}
                    <option value="{{ p.id }}" {% if app.request.get('product') == p.id %}selected{% endif %}>{{ p.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary">Filtruj</button>
        </div>
    </form>
    <div class="mb-3"><h5>Suma: {{ sum|money }}</h5></div>
    <div class="row">
        <div class="col-md-6">
            <h6>Wg kategorii</h6>
            <table class="table table-sm">
                <tr>
                    <th>kategoria</th>
                    <th>suma</th>
                </tr>
                {% for r in byCat %}
                    <tr>
                    <td>{{ (categories|filter(c => c.id == r.category_id)|first).name ?? r.category_id }}</td>
                    <td>{{ r.sum|money }}</td></tr>{% else %}
                    <tr>
                        <td colspan="2">brak</td>
                    </tr>{% endfor %}
            </table>
        </div>
        <div class="col-md-6">
            <h6>Wg sklepów</h6>
            <table class="table table-sm">
                <tr>
                    <th>sklep</th>
                    <th>suma</th>
                </tr>
                {% for r in byStore %}
                    <tr>
                    <td>{{ (stores|filter(s => s.id == r.store_id)|first).name ?? r.store_id }}</td>
                    <td>{{ r.sum|money }}</td></tr>{% else %}
                    <tr>
                        <td colspan="2">brak</td>
                    </tr>{% endfor %}
            </table>
        </div>
    </div>
    <div class="mt-3">
        <h6>TOP produkty</h6>
        <table class="table table-sm">
            <tr>
                <th>produkt</th>
                <th>suma</th>
            </tr>
            {% for r in byProductTop %}
                <tr>
                <td>{{ (products|filter(p => p.id == r.product_id)|first).name ?? r.product_id }}</td>
                <td>{{ r.sum|money }}</td></tr>{% else %}
                <tr>
                    <td colspan="2">brak</td>
                </tr>{% endfor %}
        </table>
    </div>

    <div class="mt-4">
        <h6>Porównanie gospodarstw</h6>
        <table class="table table-sm">
            <tr><th>gospodarstwo</th><th>suma</th></tr>
            {% for r in compare %}
                <tr>
                    <td>{{ r.household_id }}</td>
                    <td>{{ r.sum|money }}</td>
                </tr>
            {% else %}
                <tr><td colspan="2">brak</td></tr>
            {% endfor %}
        </table>
    </div>

{% endblock %}
